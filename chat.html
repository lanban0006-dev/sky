<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>在线对话</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  margin: 0;
  background: #0f0f0f;
  color: #fff;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
}

#app {
  max-width: 720px;
  margin: 0 auto;
  padding: 16px;
  display: flex;
  flex-direction: column;
  height: 100vh;
}

h2 {
  text-align: center;
  margin: 10px 0;
  font-size: 18px;
  color: #bbb;
}

#messages {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
  border-radius: 8px;
  background: #161616;
}

.msg {
  margin-bottom: 10px;
  max-width: 80%;
  padding: 10px 12px;
  border-radius: 10px;
  word-break: break-word;
  line-height: 1.4;
  font-size: 14px;
}

.user {
  background: #2563eb;
  margin-left: auto;
  text-align: right;
}

.admin {
  background: #333;
  margin-right: auto;
}

.time {
  font-size: 10px;
  opacity: 0.5;
  margin-top: 4px;
}

#inputBox {
  display: flex;
  gap: 8px;
  margin-top: 10px;
}

input {
  flex: 1;
  padding: 12px;
  border-radius: 6px;
  border: none;
  outline: none;
  font-size: 14px;
}

button {
  padding: 12px 16px;
  border-radius: 6px;
  border: none;
  background: #2563eb;
  color: #fff;
  font-size: 14px;
  cursor: pointer;
}

button:disabled {
  opacity: 0.5;
}
</style>
</head>

<body>
<div id="app">
  <h2>临时对话（关闭页面即失效）</h2>

  <div id="messages"></div>

  <div id="inputBox">
    <input id="text" placeholder="输入消息…" />
    <button onclick="send()">发送</button>
  </div>
</div>

<script>
const chatId = new URLSearchParams(location.search).get("chatId")
const msgBox = document.getElementById("messages")
const input = document.getElementById("text")

if (!chatId) {
  alert("会话已失效")
  location.href = "/"
}

// ===== 拉取消息 =====
async function poll() {
  try {
    const res = await fetch(`/api/chat/poll?chatId=${chatId}`)
    const data = await res.json()

    msgBox.innerHTML = data.messages.map(m => `
      <div class="msg ${m.from}">
        <div>${escapeHtml(m.text)}</div>
        <div class="time">${new Date(m.time).toLocaleTimeString()}</div>
      </div>
    `).join("")

    msgBox.scrollTop = msgBox.scrollHeight
  } catch (e) {}
}

// ===== 发送消息 =====
async function send() {
  const text = input.value.trim()
  if (!text) return

  input.value = ""
  await fetch("/api/chat/send", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ chatId, text })
  })

  poll()
}

// 防 XSS
function escapeHtml(str) {
  return str.replace(/[&<>"']/g, m => ({
    "&":"&amp;",
    "<":"&lt;",
    ">":"&gt;",
    '"':"&quot;",
    "'":"&#39;"
  })[m])
}

// 轮询
poll()
setInterval(poll, 2000)

// 回车发送
input.addEventListener("keydown", e => {
  if (e.key === "Enter") send()
})
</script>
</body>
</html>
